<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Bullpen Tracker Elite</title>

<style>
body {
  font-family: Arial;
  background: #0f172a;
  color: white;
  text-align: center;
}

h2 {
  margin: 5px;
}

canvas {
  border: 2px solid white;
  border-radius: 10px;
  background: #1e293b;
  margin: 10px;
}

button, select, input {
  padding: 6px;
  margin: 5px;
  border-radius: 6px;
  border: none;
}

button {
  background: #2563eb;
  color: white;
}

#app { display:none; }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h2>Login</h2>
  <input id="username" placeholder="Enter name">
  <br>
  <button onclick="login()">Enter</button>
</div>

<!-- APP -->
<div id="app">

<h1>Bullpen Tracker</h1>
<div id="userDisplay"></div>

<!-- PITCHERS -->
<input id="newPitcher" placeholder="Add pitcher">
<button onclick="addPitcher()">Add</button>

<select id="pitcherSelect"></select>
<button onclick="deletePitcher()">Delete</button>

<br>

<!-- OPTIONS -->
<select id="pitchType">
  <option>Four-Seam</option>
  <option>Two-Seam</option>
  <option>Changeup</option>
  <option>Slider</option>
  <option>Curveball</option>
</select>

<select id="viewMode">
  <option value="all">All Pitches</option>
  <option value="pitch">Selected Pitch</option>
  <option value="team">Entire Staff</option>
</select>

<br>

<h2>Tap to Record Pitch</h2>
<canvas id="zone" width="300" height="400"></canvas>

<h2>Heat Map</h2>
<canvas id="heat" width="300" height="400"></canvas>

<!-- STATS -->
<h3>Stats</h3>
<div id="stats"></div>

</div>

<script>
let user = "";
let data = {};

const zone = document.getElementById("zone");
const ctx = zone.getContext("2d");

const heat = document.getElementById("heat");
const heatCtx = heat.getContext("2d");

// LOGIN
function login() {
  user = document.getElementById("username").value;
  if (!user) return alert("Enter name");

  document.getElementById("login").style.display = "none";
  document.getElementById("app").style.display = "block";

  document.getElementById("userDisplay").innerText = "User: " + user;

  loadData();
  updatePitchers();
  drawZone();
  drawHeat();
  updateStats();
}

// STORAGE
function saveData() {
  localStorage.setItem("bullpen_" + user, JSON.stringify(data));
}

function loadData() {
  const saved = localStorage.getItem("bullpen_" + user);
  data = saved ? JSON.parse(saved) : {};
}

// PITCHERS
function addPitcher() {
  const name = document.getElementById("newPitcher").value.trim();
  if (!name) return;

  if (!data[name]) data[name] = [];

  saveData();
  updatePitchers();

  document.getElementById("newPitcher").value = "";
}

function deletePitcher() {
  const name = document.getElementById("pitcherSelect").value;
  delete data[name];

  saveData();
  updatePitchers();
}

// UPDATE DROPDOWN
function updatePitchers() {
  const select = document.getElementById("pitcherSelect");
  select.innerHTML = "";

  for (let p in data) {
    let opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    select.appendChild(opt);
  }
}

// DRAW STRIKE ZONE
function drawZone() {
  ctx.clearRect(0,0,300,400);
  ctx.strokeStyle = "white";
  ctx.lineWidth = 2;

  // Strike zone
  ctx.strokeRect(75,100,150,200);
}

// CLICK TRACKING (FIXED)
zone.addEventListener("click", function(e) {
  const pitcher = document.getElementById("pitcherSelect").value;
  if (!pitcher) return alert("Select pitcher");

  const rect = zone.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const pitch = {
    x,
    y,
    type: document.getElementById("pitchType").value,
    date: new Date().toLocaleDateString()
  };

  data[pitcher].push(pitch);
  saveData();

  // Draw dot instantly
  ctx.fillStyle = "yellow";
  ctx.beginPath();
  ctx.arc(x,y,4,0,Math.PI*2);
  ctx.fill();

  drawHeat();
  updateStats();
});

// HEATMAP
function drawHeat() {
  heatCtx.clearRect(0,0,300,400);

  // strike zone overlay
  heatCtx.strokeStyle = "white";
  heatCtx.strokeRect(75,100,150,200);

  const mode = document.getElementById("viewMode").value;
  const pitcher = document.getElementById("pitcherSelect").value;
  const pitchType = document.getElementById("pitchType").value;

  let pitches = [];

  if (mode === "team") {
    for (let p in data) pitches = pitches.concat(data[p]);
  } else {
    pitches = data[pitcher] || [];

    if (mode === "pitch") {
      pitches = pitches.filter(p => p.type === pitchType);
    }
  }

  pitches.forEach(p => {
    heatCtx.fillStyle = "rgba(255,0,0,0.35)";
    heatCtx.beginPath();
    heatCtx.arc(p.x,p.y,6,0,Math.PI*2);
    heatCtx.fill();
  });
}

// STATS
function updateStats() {
  const pitcher = document.getElementById("pitcherSelect").value;
  if (!pitcher || !data[pitcher]) return;

  const pitches = data[pitcher];

  let strikes = 0;

  pitches.forEach(p => {
    if (p.x>=75 && p.x<=225 && p.y>=100 && p.y<=300) strikes++;
  });

  const percent = ((strikes/pitches.length)*100).toFixed(1);

  document.getElementById("stats").innerHTML = `
    Total Pitches: ${pitches.length}<br>
    Strike %: ${percent}%
  `;
}

// UPDATE ON CHANGE
document.getElementById("pitcherSelect").addEventListener("change", ()=>{
  drawHeat();
  updateStats();
});

document.getElementById("viewMode").addEventListener("change", drawHeat);
document.getElementById("pitchType").addEventListener("change", drawHeat);

</script>

</body>
</html>
